---

- name: Create Nginx Virtual Host for IRC Webhook
  ansible.builtin.template:
    src: vhost.conf.j2
    dest: "/etc/nginx/sites-enabled/{{ webhook_fail2ban_server_name }}"
    mode: '0644'
  notify: restart_nginx

- name: Test nginx config
  ansible.builtin.command: nginx -t
  register: nginx_test
  changed_when: false
  failed_when: nginx_test.rc != 0

# TODO: git clone repo if not exists


- name: Build webhook-fail2ban-irc docker image
  community.docker.docker_image:
    source: build
    build: 
      dockerfile: "{{ webhook_fail2ban_irc_dest }}/docker/Dockerfile"
      path: "{{ webhook_fail2ban_irc_dest }}"
      args:
        BUILD: "PROD"
    name: webhook-fail2ban-irc
    tag: latest

- name: Ensure webhook-fail2ban-irc container is running
  community.docker.docker_container:
    name: webhook-fail2ban-irc
    image: webhook-fail2ban-irc:latest
    state: started
    restart_policy: unless-stopped
    ports:
      - "{{ webhook_fail2ban_container_port }}:8000"
    env:
      TZ: Europe/Paris
      IRC_SERVER: "{{ webhook_fail2ban_irc_server }}"
      IRC_CHANNEL: "{{ webhook_fail2ban_irc_channel }}"


    