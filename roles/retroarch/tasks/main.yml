---

- name: Docker Pull Image
  community.docker.docker_image_pull:
    name: "{{ item.docker.image.name }}"
    tag: "{{ item.docker.image.tag | default('latest') }}"
    pull: always
  with_items: "{{ retroarch_apps }}"

- name: Docker Run Containers
  community.docker.docker_container:
    name: "{{ item.name }}"
    image: "{{ item.docker.image.name }}:{{ item.docker.image.tag | default('latest') }}"
    state: started
    restart_policy: "{{ item.docker.restart | default('unless-stopped') }}"
    env: "{{ item.docker.environment | default(omit) }}"
    volumes: "{{ item.docker.volumes | default(omit) }}"
    ports: "{{ item.docker.ports | default(omit) }}"
    recreate: "{{ item.docker.recreate | default(false) }}"
  with_items: "{{ retroarch_apps }}"

- name: Create Nginx Virtual Host for Media Center Apps
  ansible.builtin.template:
    src: "vhost.conf.j2"
    dest: "/etc/nginx/sites-enabled/{{ item.nginx.server_name }}"
    mode: '0644'
  notify: restart_nginx
  with_items: "{{ retroarch_apps }}"

- name: Get Let's Encrypt certificates
  ansible.builtin.command: >
    certbot certonly --nginx -d {{ item.nginx.server_name }}
    --non-interactive --agree-tos --email {{ certbot_email }}
  with_items: "{{ retroarch_apps }}"
  notify: restart_nginx

- name: Test Nginx Configuration
  ansible.builtin.command: nginx -t
  register: nginx_test
  changed_when: false
  failed_when: "'successful' not in nginx_test.stderr"